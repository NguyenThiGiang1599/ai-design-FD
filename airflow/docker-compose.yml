services:
  qdrant:
    image: qdrant/qdrant:v1.9.2
    ports: ['6333:6333']
    volumes: ['qdrant-storage:/qdrant/storage']
  postgres:
    image: postgres:14
    environment:
      - POSTGRES_USER=airflow
      - POSTGRES_PASSWORD=airflow
      - POSTGRES_DB=airflow
    volumes: ['postgres-db-volume:/var/lib/postgresql/data']
  redis:
    image: redis:7
    ports: ['6379:6379']
  airflow-init:
    image: apache/airflow:2.8.3
    depends_on: [postgres]
    environment:
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres/airflow
    entrypoint: /bin/bash
    command: -c "airflow db init && airflow users create --username airflow --password airflow --firstname a --lastname b --role Admin --email a@b.c"
  airflow-webserver:
    image: apache/airflow:2.8.3
    depends_on: [postgres, redis]
    environment:
      - AIRFLOW__CORE__EXECUTOR=CeleryExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres/airflow
      - AIRFLOW__CELERY__RESULT_BACKEND=db+postgresql://airflow:airflow@postgres/airflow
      - AIRFLOW__CELERY__BROKER_URL=redis://redis:6379/0
      - _PIP_ADDITIONAL_REQUIREMENTS=qdrant-client requests pdfminer.six pillow pytesseract trafilatura readability-lxml beautifulsoup4 lxml
    volumes: ['./dags:/opt/airflow/dags','./plugins:/opt/airflow/plugins']
    ports: ['8080:8080']
    command: webserver
  airflow-scheduler:
    image: apache/airflow:2.8.3
    depends_on: [airflow-webserver]
    environment:
      - AIRFLOW__CORE__EXECUTOR=CeleryExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres/airflow
      - AIRFLOW__CELERY__RESULT_BACKEND=db+postgresql://airflow:airflow@postgres/airflow
      - AIRFLOW__CELERY__BROKER_URL=redis://redis:6379/0
      - _PIP_ADDITIONAL_REQUIREMENTS=qdrant-client requests pdfminer.six pillow pytesseract trafilatura readability-lxml beautifulsoup4 lxml
    volumes: ['./dags:/opt/airflow/dags','./plugins:/opt/airflow/plugins']
    command: scheduler
  airflow-worker:
    image: apache/airflow:2.8.3
    depends_on: [airflow-webserver]
    environment:
      - AIRFLOW__CORE__EXECUTOR=CeleryExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres/airflow
      - AIRFLOW__CELERY__RESULT_BACKEND=db+postgresql://airflow:airflow@postgres/airflow
      - AIRFLOW__CELERY__BROKER_URL=redis://redis:6379/0
      - _PIP_ADDITIONAL_REQUIREMENTS=qdrant-client requests pdfminer.six pillow pytesseract trafilatura readability-lxml beautifulsoup4 lxml
    volumes: ['./dags:/opt/airflow/dags','./plugins:/opt/airflow/plugins']
    command: celery worker
volumes:
  qdrant-storage:
  postgres-db-volume:
